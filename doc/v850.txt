
        ＝ TOPPERS/JSPカーネル ユーザズマニュアル ＝
                    (NEC V850 プロセッサ)
                Midas Lab : RTE-V850E/MA1-CB

        （Release 1.3 対応，最終更新: 06-Apr-2002）

------------------------------------------------------------------------ 
 TOPPERS/JSP Kernel
     Toyohashi Open Platform for Embedded Real-Time Systems/
     Just Standard Profile Kernel

 Copyright (C) 2000-2002 by Embedded and Real-Time Systems Laboratory
                             Toyohashi Univ. of Technology, JAPAN

 上記著作権者は，Free Software Foundation によって公表されている 
 GNU General Public License の Version 2 に記述されている条件か，以
 下の(1)〜(4)の条件を満たす場合に限り，本ソフトウェア（本ソフトウェ
 アを改変したものを含む．以下同じ）を使用・複製・改変・再配布（以下，
 利用と呼ぶ）することを無償で許諾する．
 (1) 本ソフトウェアをソースコードの形で利用する場合には，上記の著作
     権表示，この利用条件および下記の無保証規定が，そのままの形でソー
     スコード中に含まれていること．
 (2) 本ソフトウェアを再利用可能なバイナリコード（リロケータブルオブ
     ジェクトファイルやライブラリなど）の形で利用する場合には，利用
     に伴うドキュメント（利用者マニュアルなど）に，上記の著作権表示，
     この利用条件および下記の無保証規定を掲載すること．
 (3) 本ソフトウェアを再利用不可能なバイナリコードの形または機器に組
     み込んだ形で利用する場合には，次のいずれかの条件を満たすこと．
   (a) 利用に伴うドキュメント（利用者マニュアルなど）に，上記の著作
       権表示，この利用条件および下記の無保証規定を掲載すること．
   (b) 利用の形態を，別に定める方法によって，上記著作権者に報告する
       こと．
 (4) 本ソフトウェアの利用により直接的または間接的に生じるいかなる損
     害からも，上記著作権者を免責すること．

 本ソフトウェアは，無保証で提供されているものである．上記著作権者は，
 本ソフトウェアに関して，その適用可能性も含めて，いかなる保証も行わ
 ない．また，本ソフトウェアの利用により直接的または間接的に生じたい
 かなる損害に関しても，その責任を負わない．

 @(#) $Id: v850.txt,v 1.11 2002/04/14 15:27:13 hiro Exp $
------------------------------------------------------------------------


このドキュメントでは，TOPPERS/JSP V850版について解説する．

１． V850 ターゲット依存部の概要

1.1 ターゲットシステムと開発環境

V850環境の実行環境としては，次のものを想定している．

    ・Midas lab. RTE-V850E/MA1-CB

また開発環境として次のものを想定している．
    ・Soralis/BSD/Linux(POSIX) または 
        Microsoft Windows(win32) + cygwin 1.1.0
    ・binutils 2.10 (v850-nec-elf)
    ・gcc 2.95.2 (v850-nec-elf)

補足

TOPPERS/JSP V850の開発は 次の環境で行われている．

    ・Microsoft Windows XP Professional
    ・Redhat Inc. cygwin 1.3.5
    ・Vine Linux 2.2
    ・GNU binutils-2.10 v850-nec-elf
    ・GNU gcc-2.95.2 v850-nec-elf + newlib 1.8.2

1.2 サポートする機能の概要

    ・vxget_tim
        V850環境ではvxget_timをサポートする．
        ただし内容はタイマカウンタを返すのみである．

    ・多重割込み
        V850環境では割込みハンドラ起動中の多重割り込みを許可する．

    ・get_ipr [get_ixx]
        V850環境では現在実行中の割込み優先度を取得する手段として
        get_iprをサポートする．

1.3 TOPPERS/JSP V850環境の制限事項

    ・chg_ixx
        V850環境では割込み優先度の変更はサポート外である

    ・ena_int, dis_int
        V850環境では割込み許可・禁止はサポート外である．
        ただしloc_cpuとunl_cpuは同等の操作を行う．

    ・CPU例外と割り込みは同一
        V850環境ではdef_excとdef_intは同様の処理を行う．

    ・汎用レジスタ R2 は 割込みスタックレジスタとして予約
        汎用レジスタR2はプログラムの全体を通じて利用することはできない
        JSPカーネルでは、R2を割込み時スタックポインタとして利用している


２．V850環境に依存した機能

この節では，カーネルおよびシステムサービスの機能の中で，V850環境依存の部分に
ついて解説する．

2.1 データ型

int型 および unsigned int型のサイズは32ビットである．

割込み優先度を表現する型 IPR は符号なし8ビット整数である．


３．システムに依存した機能

3.1 メモリマップ

・RTE-V850E/MA1-CB
    0x00000000 - 0x0000038f : ベクタテーブル
    0x00000390 -            : プログラムコード (外部ROM)
    0x00800000 -            : プログラムデータ (SDRAM)
    0x0fffc000 - 0x0fffe7ff : システムスタック (内蔵RAM)

スタック領域は内蔵RAM領域の末尾からアドレス値が減少する方向へ進む．
データ領域は所定の領域からアドレス値が増加する方向へ確保される．
 #正確には上位8ビットは空間としての意味をなさないため，
 #実質は16kBほど確保されている．

3.2 他のシステム/チップへのポーティング

ポーティング作業は次のステップからなる．
    ・メモリマップドレジスタのアドレス値設定
    ・タイマー値の設定
    ・RAM開始番地の設定
    ・イニシャルスタックポインタの設定

3.2.1 メモリマップドレジスタのアドレス値設定

TOPPERS/JSP V850環境ではいくつかの制御レジスタを参照している．
これらは全てシステム依存部用ディレクトリのsys_defs.hで定義されている．
利用者は必要に応じてこれらの値を修正すること．

3.2.2 タイマー値の設定

TOPPERS/JSP V850環境では標準で1msごとに割込みを発生させている．

割込みを発生させるまでの時間はタイマコンペアレジスタの値をマニュアルに
したがって調整することで帰ることができる．

config/v850/rtev850ema1cb/sys_defs.h:52

	/* RTE-V850E/MA1-CB 50MHz で 1msec */
#define TIMER_PORT            0
#define TIMER_INT_PRIORITY    0
#define TIMER_PRESCALER       2      /* clk = f/16 */
#define TIMER_COMPAREVALUE    3125

またタイムティック自体を修正する場合はsys_defs.h:138,139のTIC_NUMEおよび
TIC_DENOを修正する．それぞれは次式に従う．

タイムティック(ms) = TIC_NUME(ms) / TIC_DENO(ms)

3.2.3 RAM開始番地の設定

config/v850/rtev850ema1cb/v850elf.ldのMEMORY部の内容を修正することで、メモリ
のサイズおよび位置を変えることができる。また、各セクションの末尾にある 
"> SDRAM" または "> EXTROM"を変えることで、配置する空間を変えることも可能である。

3.2.4 イニシャルスタックポインタの設定

起動時に設定される初期スタックポインタの番地はconfig/v850/rtev850ema1cb/sys_
config.h:66のSTACKTOPに記述されている．このSTACKTOPには4バイトアライン
された値を格納する．

config/v850/(sys)/sys_config.h:66
	#define	STACKTOP 0x0fffe800	/* 非タスクコンテキスト用のスタックの初期値 */

スタックはプリデクリメントスタックであるため，STACKTOPで示されたアドレス
には何も格納されないことに注意されたい．

3.2.5 その他の設定

    ・タイマ割り込みの番号
        config/v850/(sys)/hw_timer.h:52 INHNO_TIMER宣言
            タイマが発生する割込みの番号


４．開発環境の構築

開発環境の構築方法については，GNU開発環境構築マニュアルを参照すること．


５．その他

5.1 ディレクトリ・ファイル構成

TOPPERS/JSP V850依存部 構成ファイル ツリー

[jsp]
  +- [doc]
  |   +- v850.txt  : このファイル
  +- [config]
      +- [v850]
          +- cpu_config.h    : プロセッサ依存モジュール
          +- cpu_config.c    : プロセッサ依存モジュール
          +- cpu_context.h   : タスクコンテキスト操作ルーチン
          +- cpu_defs.h      : CPU依存情報定義ファイル
          +- cpu_support.S   : CPU依存アセンブラコーディング部
          +- Makefile.config : CPU依存Makefile
          +- makeoffset.c    : 構造体オフセット位置取得用
          +- start.S         : スタートアップ / 割込みハンドラ
          +- v850asm.inc     : アセンブラ用インクルードファイル
          +- [rtev850ema1cb]
              +- Makefile.config : システム依存Makefile
              +- hw_timer.h      : タイマ操作   (V850E内蔵タイマD)
              +- hw_serial.h     : シリアル操作 (V850E内蔵非同期SIO)
              +- sys_config.h    : システム依存モジュール
              +- sys_config.c    : システム依存モジュール
              +- sys_defs.h      : システム依存定義ファイル
              +- sys_support.S   : システム依存アセンブラ部
              +- v850elf.ld      : リンカスクリプト


６．バージョン履歴
	2002年 4月 6日  Release 1.3
		・rel 1.3にあわせ、ドキュメントの一部に間違いがったのを修正

	2001年11月15日  Release 1.2
		・RTE-V850E/MA1-CBのサポート

	2001年 2月23日  Release 1.1
		TOPPERS/JSP release 1.1 に合わせていろいろ修正
		・gcc -ffix-REGの存在を知り、この文章とMakefileを修正

    2000年11月27日  Release 1.0
        ・ドキュメント完成
        ・割込み前後処理ルーチンを改良 レジスタ退避を2回に分ける
        ・ディスパッチャが次タスクなし状態時に前のタスクスタックを
            利用してしまうバグを修正

    2000年11月19日  Release 0.9
        ・最初のリリース
