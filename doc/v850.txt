
        ＝ TOPPERS/JSPカーネル ユーザズマニュアル ＝
             (NEC V850 およびその互換プロセッサ)

        （Release 1.1β対応，最終更新: 24-Feb-2001）

------------------------------------------------------------------------ 
 TOPPERS/JSP Kernel
     Toyohashi Open Platform for Embedded Real-Time Systems/
     Just Standard Profile Kernel

 Copyright (C) 2000,2001 by Embedded and Real-Time Systems Laboratory
                             Toyohashi Univ. of Technology, JAPAN

 上記著作権者は，以下の条件を満たす場合に限り，本ソフトウェア（本ソ
 フトウェアを改変したものを含む．以下同じ）を使用・複製・改変・再配
 布（以下，利用と呼ぶ）することを無償で許諾する．
 (1) 本ソフトウェアをソースコードの形で利用する場合には，上記の著作
     権表示，この利用条件および下記の無保証規定が，そのままの形でソー
     スコード中に含まれていること．
 (2) 本ソフトウェアをバイナリコードの形または機器に組み込んだ形で利
     用する場合には，次のいずれかの条件を満たすこと．
   (a) 利用に伴うドキュメント（利用者マニュアルなど）に，上記の著作
       権表示，この利用条件および下記の無保証規定を掲載すること．
   (b) 利用の形態を，別に定める方法によって，上記著作権者に報告する
       こと．
 (3) 本ソフトウェアの利用により直接的または間接的に生じるいかなる損
     害からも，上記著作権者を免責すること．

 本ソフトウェアは，無保証で提供されているものである．上記著作権者は，
 本ソフトウェアに関して，その適用可能性も含めて，いかなる保証も行わ
 ない．また，本ソフトウェアの利用により直接的または間接的に生じたい
 かなる損害に関しても，その責任を負わない．

 @(#) $Id: v850.txt,v 1.5 2001/02/23 20:21:27 takayuki Exp $
------------------------------------------------------------------------


このドキュメントでは，TOPPERS/JSP V850版について解説する．

１． V850 ターゲット依存部の概要

1.1 ターゲットシステムと開発環境

V850環境の実行環境としては，次のものを想定している．

    ・NEC V850チップ搭載ターゲットボード

また開発環境として次のものを想定している．
    ・Soralis/BSD/Linux(POSIX) または 
        Microsoft Windows(win32) + cygwin 1.1.0
    ・binutils 2.10 (v850-nec-elf)
    ・gcc 2.95.2 (v850-nec-elf)

補足

TOPPERS/JSP V850の開発は 次の環境で行われている．

    ・Microsoft Windows 2000 Professional
        + Microsoft Windows 2000 ServicePack1
    ・Redhat Inc. cygwin 1.1.0
    ・Vine Linux 2.2
    ・GNU binutils-2.10 v850-nec-elf
    ・GNU gcc-2.95.2 v850-nec-elf + newlib 1.8.2
        #gccには修正を加えている

1.2 サポートする機能の概要

    ・vxget_tim
        V850環境ではvxget_timをサポートする．
        ただし内容はタイマカウンタを返すのみである．

    ・多重割込み
        V850環境では割込みハンドラ起動中の多重割り込みを許可する．

    ・get_ipr [get_ixx]
        V850環境では現在実行中の割込み優先度を取得する手段として
        get_iprをサポートする．

1.3 TOPPERS/JSP V850環境の制限事項

    ・chg_ixx
        V850環境では割込み優先度の変更はサポート外である

    ・ena_int, dis_int
        V850環境では割込み許可・禁止はサポート外である．
        ただしloc_cpuとunl_cpuは同等の操作を行う．

    ・CPU例外と割り込みは同一
        V850環境ではdef_excとdef_intは同様の処理を行う．

    ・汎用レジスタ R2 は 割込みスタックレジスタとして予約
        汎用レジスタR2はプログラムの全体を通じて利用することはできない
         #gccに細工が必要となる

    ・シリアル入出力
        シリアル入出力は現在サポート外である．


２．V850環境に依存した機能

この節では，カーネルおよびシステムサービスの機能の中で，V850環境依存の部分に
ついて解説する．

2.1 データ型

int型 および unsigned int型のサイズは32ビットである．

割込み優先度を表現する型 IPR は符号なし8ビット整数である．


３．システムに依存した機能

3.1 メモリマップ

・uPD703000
コード領域
    0x00000000 - 0x0000025f : ベクタテーブル
    0x00000260 -            : プログラムコード
データ領域
    0x00ffb000 - 0xfffff000 : RAM

スタック領域は0xfffff000からアドレス値が減少する方向へ進む．
データ領域は0x00ffb000からアドレス値が増加する方向へ確保される．
 #正確には上位8ビットは空間としての意味をなさないため，
 #実質は16kBほど確保されている．

3.2 他のシステム/チップへのポーティング

ポーティング作業は次のステップからなる．
    ・メモリマップドレジスタのアドレス値設定
    ・タイマー値の設定
    ・RAM開始番地の設定
    ・イニシャルスタックポインタの設定

3.2.1 メモリマップドレジスタのアドレス値設定

TOPPERS/JSP V850環境では次のレジスタを参照している．

タイマ制御レジスタ          TMC     (TIMERMODECONTROL)
タイマコンペアレジスタ      CM      (COMPAREREGISTER)
タイマ割込み制御レジスタ    TMIC    (TIMERINTCONTROL)
タイマカウンタ              TM      (TIMERCOUNTER)
実行中割込み優先度レジスタ  ISPR    (INSERPRIREG)

これらは全てシステム依存部用ディレクトリのsys_defs.hで定義されている．
利用者は必要に応じてこれらの値を修正すること．

3.2.2 タイマー値の設定

TOPPERS/JSP V850環境では標準で5msごとに割込みを発生させている．
割込みを発生させるまでの時間はタイマコンペアレジスタの値をマニュアルに
したがって調整することで帰ることができる．

config/v850/(sys)/sys_defs.h:53
        /* uPD703000 25MHz で 5msec */
    #define COMPAREVALUE        0x100

またタイムティック自体を修正する場合はsys_defs.h:81,82のTIC_NUMEおよび
TIC_DENOを修正する．それぞれは次式に従う．

タイムティック(ms) = TIC_NUME(ms) / TIC_DENO(ms)

3.2.3 RAM開始番地の設定

RAMの開始番地を変更するにはconfig/v850/v850elf.ld:28を修正する．
標準では0x00ffb000に設定されている．

config/v850/v850elf.ld
    . = 0x00ffb000;

3.2.4 イニシャルスタックポインタの設定

起動時に設定される初期スタックポインタの番地はconfig/v850/(sys)/sys_
config.h:54のSTACKTOPに記述されている．このSTACKTOPには4バイトアライン
された値を格納する．

config/v850/(sys)/sys_config.h:54
    #define STACKTOP 0xfffff000 /* 非タスクコンテキスト用のスタックの初期値 */

スタックはプリデクリメントスタックであるため，STACKTOPで示されたアドレス
には何も格納されないことに注意されたい．

3.2.5 その他の設定

    ・タイマ割り込みの番号
        config/v850/(sys)/hw_timer.h:44 INHNO_TIMER宣言
            タイマが発生する割込みの番号


４．開発環境の構築

開発環境の構築方法については，GNU開発環境構築マニュアルを参照すること．


５．その他

5.1 ディレクトリ・ファイル構成

1.4 TOPPERS/JSP Windows-HAL 構成ファイル

[jsp]
  +- [doc]
  |   +- v850.txt  : このファイル
  +- [config]
  |   +- [v850]
  |       +- cpu_config.h    : プロセッサ依存モジュール
  |       +- cpu_config.c    : プロセッサ依存モジュール
  |       +- cpu_context.h   : タスクコンテキスト操作ルーチン
  |       +- cpu_defs.h      : CPU依存情報定義ファイル
  |       +- cpu_support.S   : CPU依存アセンブラコーディング部
  |       +- Makefile.config : CPU依存Makefile
  |       +- makeoffset.c    : 構造体オフセット位置取得用
  |       +- start.S         : スタートアップ / 割込みハンドラ
  |       +- v850asm.inc     : アセンブラ用インクルードファイル
  |       +- v850elf.ld      : v850-nec-elfリンカスクリプト
  |       +- [upd703000]
  |           +- Makefile.config : システム依存Makefile
  |           +- hw_timer.h      : タイマ操作
  |           +- sys_config.h    : システム依存モジュール
  |           +- sys_config.c    : システム依存モジュール
  |           +- sys_defs.h      : システム依存定義ファイル
  |           +- sys_support.S   : システム依存アセンブラ部
  +- [V850]
      +- sample1.cfg : サンプルプログラム 構成情報ファイル
      +- sample1.h   : サンプルプログラム ヘッダー
      +- sample1.c   : サンプルプログラム


６．バージョン履歴
	2001年 2月23日  Release 1.1
		TOPPERS/JSP release 1.1 に合わせていろいろ修正
		・gcc -ffix-REGの存在を知り、この文章とMakefileを修正

    2000年11月27日  Release 1.0
        ・ドキュメント完成
        ・割込み前後処理ルーチンを改良 レジスタ退避を2回に分ける
        ・ディスパッチャが次タスクなし状態時に前のタスクスタックを
            利用してしまうバグを修正

    2000年11月19日  Release 0.9
        ・最初のリリース
