
	    ＝ TOPPERS/JSPカーネル ユーザズマニュアル ＝
                 （i386 ターゲット依存部）

            （Release 1.2対応，最終更新: 14-Nov-2001）

------------------------------------------------------------------------ 
 TOPPERS/JSP Kernel
     Toyohashi Open Platform for Embedded Real-Time Systems/
     Just Standard Profile Kernel

 Copyright (C) 2000,2001 by Embedded and Real-Time Systems Laboratory
                             Toyohashi Univ. of Technology, JAPAN
 Copyright (C) 2002 by Monami software, Limited Partners

 上記著作権者は，Free Software Foundation によって公表されている 
 GNU General Public License の Version 2 に記述されている条件か，以
 下の(1)〜(4)の条件を満たす場合に限り，本ソフトウェア（本ソフトウェ
 アを改変したものを含む．以下同じ）を使用・複製・改変・再配布（以下，
 利用と呼ぶ）することを無償で許諾する．
 (1) 本ソフトウェアをソースコードの形で利用する場合には，上記の著作
     権表示，この利用条件および下記の無保証規定が，そのままの形でソー
     スコード中に含まれていること．
 (2) 本ソフトウェアを再利用可能なバイナリコード（リロケータブルオブ
     ジェクトファイルやライブラリなど）の形で利用する場合には，利用
     に伴うドキュメント（利用者マニュアルなど）に，上記の著作権表示，
     この利用条件および下記の無保証規定を掲載すること．
 (3) 本ソフトウェアを再利用不可能なバイナリコードの形または機器に組
     み込んだ形で利用する場合には，次のいずれかの条件を満たすこと．
   (a) 利用に伴うドキュメント（利用者マニュアルなど）に，上記の著作
       権表示，この利用条件および下記の無保証規定を掲載すること．
   (b) 利用の形態を，別に定める方法によって，上記著作権者に報告する
       こと．
 (4) 本ソフトウェアの利用により直接的または間接的に生じるいかなる損
     害からも，上記著作権者を免責すること．

 本ソフトウェアは，無保証で提供されているものである．上記著作権者は，
 本ソフトウェアに関して，その適用可能性も含めて，いかなる保証も行わ
 ない．また，本ソフトウェアの利用により直接的または間接的に生じたい
 かなる損害に関しても，その責任を負わない．

 @(#) $Id: i386.txt,v 1.2 2002/04/06 12:23:01 honda Exp $
------------------------------------------------------------------------


１．i386 ターゲット依存部の概要

1.1 ターゲットシステムと開発環境

i386 プロセッサのターゲットシステムとしては，PC/AT互換のPC用マザーボー
ドをサポートしている．

また，FPU はサポートしてない.
CPUはi386上位互換であれば問題なく動作するが、以下では、i386上位互換CPU
の総称としてi386という表現を用いる.

開発環境には，GCC などの GNU開発環境を用い，オブジェクトファイルフォー
マットは ELF を標準とする．


1.2 サポートする機能の概要

i386 依存の機能として，割込みの禁止と許可(dis_int，ena_int)をサポート
している.
割込みマスクの変更・参照(chg_ixx，get_ixx)と，性能評価用システム時刻参
照機能(vxget_tim)をはサポートしていない．


1.3 他のターゲットへのポーティング

CPUはi386上位互換であれば問題なく動作すると思われる。動作確認に用いた
CPUはPentium (133MHz)である。


1.4 ブートローダ

i386版のTOPPERS/JSPカーネルは、multiboot準拠のブートローダから起動する
ことを前提としている。
他のCPU用のTOPPERS/JSP カーネルとは異なり、i386版のカーネルには GDB ス
タブのサポートが存在しない。
そのため，sys_putc は割り込みハンドラを直叩きすることで実現している。
GDB_STUB というコンパイルフラグは用いられないので注意が必要である。


1.5 シリアルポート

i386版では，カーネルのログ出力用に1つのシリアルポート使用する．
使用するポートは、いわゆるCOM1である。
ボーレート:9600bps,データ:8bit,Parity:none,Stop:1bitである．



２．i386 プロセッサ依存部の機能

この節では，カーネルおよびシステムサービスの機能の中で，i386依存の部分
について解説する．

2.1 データ型

int型および unsigned int型のサイズは 32ビットである．

2.2 割込み管理機能と割込みハンドラ

DEF_INH で指定する割込みハンドラ番号(inhno)は，i386 では，
割り込みディスクリプタテーブル(IDT)の割込み番号である.
i386では,inhnoは33から255までが有効である. この範囲外の
inhnoを指定した場合の動作は保証されない. 
(IDTの割込み番号0x20以下の番号は,インテル社によって
将来のプロセッサのために予約されている.)
この範囲のinhnoを指定した場合の動作も保証されない.

2.3 CPU例外管理機能とCPU例外ハンドラ

DEF_EXC で指定する割込みハンドラ番号(excno)は，i386 での
フォールトもしくはアボートに相当する割り込み番号である.

2.4 スタートアップモジュール

i386依存のスタートアップモジュール(start.S)では，次の初期化処理を行う．

(A) プロセッサモードの初期化とスタックポインタの初期化

最初に，スタックポインタを STACKTOP に設定する．ここで割込みスタッ
クポインタに設定されたスタック領域は，カーネル起動後は非タスクコンテキ
スト用のスタック領域として使われる．STACKTOP は，sys_config.h 部で定義
することを想定している．

(B) hardware_init_hook の呼出し

hardware_init_hook が 0 でない場合には，hardware_init_hook を呼び出す．
hardware_init_hook は，カーネルが起動される前に行う必要があるターゲッ
ト依存の初期化を行うために用意している．hardware_init_hook がどこでも
定義されていない場合，リンカでこのシンボルを 0 に定義する(リンカスク
リプト内に記述あり)．

(C) software_init_hook の呼出し

software_init_hook が 0 でない場合には，software_init_hook を呼び出す．
software_init_hook は，カーネルが起動される前に行う必要があるソフトウェ
ア環境(具体的には，ライブラリ)依存の初期化を行うために用意している．
software_init_hook がどこでも定義されていない場合，リンカでこのシンボ
ルを 0 に定義する(リンカスクリプト内に記述あり)．

(E) カーネルの起動

kernel_start へ分岐し，カーネルを起動する．kernel_start からリターンし
てくることは想定していない．


３．システム依存部の機能

3.1 システムクロックドライバ

システムクロックドライバが isig_tim を呼び出す周期は，sys_defs.h 中の 
TIC_NUME と TIC_DENO で定義されている(標準は 1ミリ秒周期)．この定義
を変更することで，isig_tim を呼び出す周期を変更することができる．ただ
し，タイマの精度が 1μ秒であるため，1μ秒単位で端数になる値を設定した
場合には，isig_tim の呼出し周期に誤差が生じることになる．

3.2 性能評価用システム時刻参照機能

i386依存部では，性能評価用システム時刻参照機能(vxget_tim)をサポートして
いない．

3.3 シリアルインタフェースドライバ

シリアルインタフェースドライバは，PC/AT互換環境で一般的な16550互換のシ
リアルをサポートしてる． COM1がI/O port 0x3F9, IRQ4 の割り込みを用いる
ことを前提としている. ポートアドレスや割り込みを変更する場合には
sys_config.hやhw_serial.hを適宜書き換えること。
COM2,COM3,COM4 のための処理は,現在のところサポートされていない.

3.4 メモリマップ

4GBフラットメモリモデルである。コード領域は 0x01000000〜


４．開発環境の構築

開発環境の構築方法については，GNU開発環境構築マニュアルを参照のこと．

4.1 開発環境のバージョン
動作確認したツールのバージョンは以下の通りである．

    BINUTILS : 2.10.1
    GCC-CORE : 2.95.3
    GDB      : 4.18
    NEWLIB   : 1.9.0


５．その他

5.1 ディレクトリ・ファイル構成

i386 ターゲット依存部の各ファイルの概要は次の通り．

    config/i386/
	Makefile.config Makefileの i386 依存定義
    cpu_defs.h      プロセッサ依存部のアプリケーション用定義
    cpu_config.h    プロセッサ依存部の構成定義
    cpu_config.c    プロセッサ依存部の関数
    cpu_support.S   プロセッサ依存部のサブルーチン
    cpu_context.h   コンテキスト操作
    makeoffset.c    offset.h 生成サポートプログラム
    cpu_insn.h      低レベルのプロセッサ操作ルーチン
    i386.h          i386 の定義
    elf_i386.ld	    ローダ用のスクリプト定義

    config/i386/pcat/
    Makefile.config Makefileの PC/AT 依存定義
    hw_serial.h     シリアルインタフェースデバイス操作ルーチン
    hw_timer.h      タイマ操作ルーチン
    irc.h	    割り込みコントローラの構成定義
    irc_inline.h    割り込みコントローラ用のインライン関数群
    multiboot.h	    マルチブート標準用の構成定義
    start.S         スタートアップモジュール(multiboot用)
    sys_config.c    システム依存部の関数
    sys_config.h    システム依存部の構成定義
    sys_defs.h      システム依存部のアプリケーション用定義
    sys_support.S   システム依存部のサブルーチン
